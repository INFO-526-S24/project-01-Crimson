---
title: "Big Tech Stock Prices"
subtitle: "INFO 526 - Project 1"
author: 
  - name: "Team Crimson - Arun, Varun, Jasdeep, Mohit, Pradnya"
format: 
  html:
    embed-resources: true
    code-line-numbers: true
    code-overflow: wrap
    code-tools: true
editor: visual
code-annotations: hover
categories: 
  - Data visualization
  - TidyTuesday
---

## Abstract

This data visualization project aims to comprehend the patterns in the stock prices of major tech companies over a 10-year period. Given the inherent volatility of stock prices, various factors, including external disturbances, contribute to fluctuations. The project delves into comprehending the patterns in big tech company stock prices, particularly with respect to the impact of COVID-19. Our visualization techniques, including bar plots and line plots, play a crucial role in explaining the stock price phenomena.

In the second part of the project, we offer a more lucid understanding of stock price trends across financial quarters and weekdays. This insightful analysis empowers stakeholders with the information needed for informed decision-making and the formulation of proactive trading strategies.

[*Note: Given that we only have access to stock prices, establishing causality regarding the impact of stock prices in relation to COVID-19 may pose challenges. So, instead we will be observing trends and returns.*]{style="font-size: small;"}

## Introduction

The [Big Tech Stock Prices dataset](https://github.com/rfordatascience/tidytuesday/tree/master/data/2023/2023-02-07), sourced from the TidyTuesday project, provides a comprehensive overview of the daily stock prices and trading volumes of 14 prominent technology companies. The list of industry giants that are studied for data analysis are Apple, Adobe, Amazon.com, Salesforce, Cisco Systems, Alphabet, IBM, Intel, Meta, Microsoft, Netflix, NVIDIA, Oracle and TESLA.

Comprising two tables, namely `big_tech_stock_prices.csv` and `big_tech_companies.csv`, this dataset offers a ample amount of information for conducting in-depth analysis and exploring various aspects of the stock market. The big_tech_stock_prices.csv file contains detailed records of daily stock prices and trading volumes for each company, while the big_tech_companies.csv file provides additional information about the included companies, such as their names and stock symbols.

\<\<\< Pending to write \>\>

## Question 1 : Which companies have experienced the highest/lowest impact on their stock prices due to the pandemic?

### Introduction

\<\<\< Team-1 to write \>\>

### Approach

\<\<\< Team-1 to write \>\>

### Analysis

```{r}
#| label: load-pkgs
#| message: FALSE
#| warning: FALSE
#| echo: FALSE

### GETTING THE LIBRARIES
#devtools::install_github("choonghyunryu/dlookr")

if (!require(pacman))
  install.packages(pacman)

# Loading the libraries
pacman::p_load(tidyverse,
               tidytuesdayR,
               dlookr,
               ggthemes,
               ggplot2,
               gganimate,
               dplyr,
               ggridges,
               formattable,
               plotly,
               broom,
               cowplot)

```

```{r}
#| label: load-dataset
#| message: FALSE
#| warning: FALSE
#| echo: FALSE
#| output: FALSE

# Loading the data from tidy tuesday repository
#bigtech <- tidytuesdayR::tt_load('2023-02-07')
big_tech_stock_prices <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-02-07/big_tech_stock_prices.csv')
big_tech_companies <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-02-07/big_tech_companies.csv')
```

```{r}
#| label: graph1
#| message: FALSE
#| warning: FALSE
#| echo: FALSE
#| fig-width: 8
#| fig-align: center
#| dpi: 300

big_tech_companies <- big_tech_companies |>
  mutate(
    CompanyName = str_replace(company, " Inc", ""),
    CompanyName = if_else(stock_symbol == "IBM", "IBM", CompanyName),
    CompanyName = str_replace(CompanyName, ",", ""),
    CompanyName = str_replace(CompanyName, ".com", ""),
    CompanyName = str_replace(CompanyName, "\\.", ""),
    CompanyName = str_replace(CompanyName, "Corporation", ""),
    CompanyName = str_replace(CompanyName, "Systems", ""),
    CompanyName = str_replace(CompanyName, "Platforms", "")
  )

plot1 <-  left_join(big_tech_stock_prices,big_tech_companies) |> 
          ggplot(aes(x=date,y=adj_close , color = CompanyName)) + 
          geom_line() + scale_colour_manual(name = "Company", 
                                            values = c("orange", "grey", "grey", "grey", "grey",
                                                       "grey", "grey", "grey", "grey","brown",
                                                       "grey", "grey", "grey", "grey")) +
          scale_x_date(breaks = seq(from = as.Date("2010-01-01"),
                                    to = as.Date("2022-01-01"),
                                    by = "2 years"),
                       minor_breaks = "1 year",
                       date_labels = "%Y") +
          scale_y_continuous(limits = c(0, 750)) +
          annotate(
            "text",
            x = as.Date("2020-03-17"),
            y = 680,
            label = "COVID-19 \n Pandemic",
            vjust = -0.5,  # Adjust vertical position of the label
            color = "cornsilk4"
          ) +
          geom_vline(
            xintercept = as.numeric(as.Date("2021-11-17")),
            linetype = "dashed",
            color = "darkgreen"
          ) +
          annotate(
            "text",
            x = as.Date("2021-11-17"),
            y = 680,
            label = "Lower Ad \n Revenue",
            vjust = -0.5,  # Adjust vertical position of the label
            color = "darkred"
          ) +
          geom_vline(
            xintercept = as.numeric(as.Date("2020-03-17")),
            linetype = "dashed",
            color = "darkgreen"
          ) +
          labs(
            x = "Year", 
            y = "Stock Price", 
            fill = NULL,
            title = ""
          ) + 
          theme_minimal() +
          theme(
            legend.position = c(0.10,0.6),
            legend.box.background = element_rect(fill = "white",
                                                 color = "white"),
            legend.title = element_blank()
          ) +
          annotate(
            "text",
            x = as.Date("2015-05-17"),
            y = 300,
            label = "Highlighted companies in 2022 
            have faced internal challenges, 
            such as a slowdown in subscribers for Netflix
            and pricing factors affecting Adobe",
            vjust = -0.5,  # Adjust vertical position of the label
            color = "darkred",
            size = 3,
            fontface = "italic"
          ) +
          annotate(
            "text",
            x = as.Date("2016-11-17"),
            y = 500,
            label = "All tech companies have seen an initial fall 
            when COVID was declared a pandemic, 
            but later, during the quarantine, 
            the benefits of technology are conspicuous",
            vjust = -0.5,  # Adjust vertical position of the label
            color = "cornsilk4",
            size = 3, 
            fontface = "italic"
        )

plot1

```

```{r}
#| label: graph2
#| message: FALSE
#| warning: FALSE
#| echo: FALSE
#| fig-width: 8
#| fig-align: center
#| dpi: 300

models <- big_tech_stock_prices |>
  group_by(stock_symbol) |>
  group_modify(~ augment(lm(adj_close ~ date, data = .))) |>
  mutate(ratio = adj_close /.fitted, .after = .fitted) |>
  select(stock_symbol,date,adj_close,ratio)


plot2 <- 
  left_join(models,big_tech_companies) |>
  ggplot(aes(x = date, y = ratio, color = CompanyName)) +
  geom_line() + scale_colour_manual(name = "Company", 
                                    values = c("orange", "grey", "grey", 
                                               "grey", "grey","grey", 
                                               "grey", "grey", "grey",
                                               "brown","grey", "grey", 
                                               "grey", "grey")) +
  geom_hline(yintercept = 1, color = "darkgreen") +
  scale_x_date(breaks = seq(from = as.Date("2010-01-01"), to = as.Date("2023-01-01"),
                            by = "2 years"), minor_breaks = "1 year", date_labels = "%Y") + 
  coord_cartesian(ylim = c(0, 2) , 
                  xlim = c(as.Date("2018-01-01"), as.Date("2023-01-01"))) +
  labs(
    title = "Stock Price Changes over 5 Years",
    subtitle = "2018-2022 (Detrended)",
    x = "Year", 
    y = "Stock Price Ratio \n (detrended)"
  ) + 
  facet_wrap(~CompanyName) + 
  guides(color = "none") + 
  theme_minimal()

plot2

```

```{r}
#| label: graph3
#| message: FALSE
#| warning: FALSE
#| echo: FALSE
#| fig-width: 8
#| fig-align: center
#| dpi: 300

dates = big_tech_stock_prices |> 
  group_by(year(date)) |> 
  summarize(min_date = min(date), max_date = max(date))

dates = c("2018-01-02","2020-01-02", "2022-12-29")

closings = big_tech_stock_prices |>
  filter(as.Date(date) %in% as.Date(dates)) |>
  mutate(year=year(date)) |> 
  select(stock_symbol,year,adj_close) |> 
  pivot_wider(names_from = stock_symbol, values_from = adj_close) |> 
  column_to_rownames(var = "year") |> 
  t() |>  
  as.data.frame() |> 
  rownames_to_column(var="stock_symbol") |> 
  mutate(
    Two_Years = round(((`2020` - `2018`)/`2018`)*100,2)/2, 
    Five_Years = round(((`2022` - `2018`)/`2018`)*100,2)/5
  ) |> 
  select(stock_symbol,Two_Years,Five_Years) 


plot3 <- 
  left_join(closings,big_tech_companies) |> 
  ggplot(aes( x = reorder(CompanyName, Two_Years), Two_Years, fill = CompanyName)) + 
  scale_fill_manual(name = "Company", 
                      values = c("orange", "#fde725", "#c2df23", 
                                 "#86d549", "#52c569","#2ab07f", 
                                 "#1e9b8a", "#25858e", "#2d708e",
                                 "brown","#38588c", "#433e85", 
                                 "#482173", "#440154")) + 
  geom_bar(stat = "identity") + 
  coord_flip() + 
  labs(
    x = "Two Year Returns",
    y = "% Returns",
    title = "Avg. of two year returns %",
    subtitle = "2018 to 2020; Pre-Pandemic"
  ) +
  theme_minimal() + 
  guides(fill = "none") 
  

plot4 <- 
  left_join(closings,big_tech_companies) |> 
  ggplot(aes( x = reorder(CompanyName, Five_Years), Five_Years, fill = CompanyName)) + 
  scale_fill_manual(name = "Company", 
                    values = c("orange", "#fde725", "#c2df23", 
                               "#86d549", "#52c569","#2ab07f", 
                               "#1e9b8a", "#25858e", "#2d708e",
                               "brown","#38588c", "#433e85", 
                               "#482173", "#440154")) + 
  geom_bar(stat = "identity") + 
  coord_flip() + 
  labs(
    x = "Five Year Returns",
    y = "% Returns",
    title = "Avg. of five year returns %",
    subtitle = "2018 to 2023"
  ) +
  theme_minimal() + 
  guides(fill = "none") 


cowplot::plot_grid(plot3,plot4, ncol = 2)

```

### Discussion

\<\<\< Team-1 to write \>\>

## Question 2 : What are the patterns in returns on stock prices based on days of the week and financial quarters?

### Introduction

\<\<\< Team-2 to write \>\>

### Approach

\<\<\< Team-2 to write \>\>

### Analysis

\<\<\< Team-2 to write \>\>

```{r q2_graph1}
#| label: q2_graph1
#| message: FALSE
#| warning: FALSE
#| echo: FALSE
#| fig-width: 8
#| fig-align: center

# Load the data from csv files
big_tech_stock_prices <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-02-07/big_tech_stock_prices.csv')
big_tech_companies <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-02-07/big_tech_companies.csv')


big_tech_companies <- big_tech_companies |>
  mutate(
    CompanyName = str_replace(company, " Inc", ""),
    CompanyName = if_else(stock_symbol == "IBM", "IBM", CompanyName),
    CompanyName = str_replace(CompanyName, ",", ""),
    CompanyName = str_replace(CompanyName, ".com", ""),
    CompanyName = str_replace(CompanyName, "\\.", ""),
    CompanyName = str_replace(CompanyName, "Corporation", ""),
    CompanyName = str_replace(CompanyName, "Systems", ""),
    CompanyName = str_replace(CompanyName, "Platforms", ""),
    CompanyName = str_trim(CompanyName) 
  )

 # Calculate gain days
gain_days <- big_tech_stock_prices |>
  mutate(
    year = lubridate::year(date) ,
    quarter = lubridate::quarter(date),
    weekday = weekdays(date),
    gain = if_else(close - open > 0, 1, 0)
  ) |> 
  group_by(stock_symbol,year,quarter,weekday) |>
  summarise(gain_count = sum(gain), .groups = "drop")

weekday_order <- c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")

company_colors <- c(
  "Adobe" = "orange", 
  "Alphabet" = "#fde725", 
  "Amazon" = "#c2df23", 
  "Apple" = "#86d549", 
  "Cisco" = "#52c569",
  "IBM" = "#2ab07f", 
  "Intel" = "#1e9b8a", 
  "Meta" = "#25858e", 
  "Microsoft" = "#2d708e",
  "Netflix" = "brown",
  "NVIDIA" = "#38588c", 
  "Oracle" = "#433e85", 
  "Salesforce" = "#482173", 
  "Tesla" = "#440154"
)

# Join the data and Plot density ridges
left_join(gain_days,big_tech_companies) |>
  ggplot(aes(x = gain_count,
             y = factor(weekday, levels = weekday_order),
             fill = CompanyName)) +
  geom_density_ridges(scale = 3,
                      rel_min_height = 0.01,
                      alpha = 0.6) +
  scale_fill_manual(values = company_colors) +
  labs(title = "Distribution of Gain Days by Weekday for Each Company",
       x = "Gain Days Count") +
  theme_solarized() +
  theme(axis.text.x = element_text(size = 14, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
        axis.title = element_text(size = 18, face = "bold",),
        legend.position = "none",
        panel.spacing = unit(0.9, "lines")) +
  coord_cartesian(xlim = c(0, 15),
                  expand = FALSE) +
  scale_x_continuous(breaks = seq(0, 15, by = 3)) +
  facet_wrap(~ CompanyName)
```

```{r q2_graph2}

#| label: q2_graph2
#| message: FALSE
#| warning: FALSE
#| echo: FALSE
#| fig-width: 8
#| fig-align: center

library(ggplot2)
library(dplyr)
library(tidyr)
library(stringr)
library(gganimate)

# Load data
big_tech_stock_prices <- read.csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-02-07/big_tech_stock_prices.csv")
big_tech_companies <- read.csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-02-07/big_tech_companies.csv")

big_tech_companies <- big_tech_companies |>
  mutate(
    CompanyName = str_replace(company, " Inc", ""),
    CompanyName = if_else(stock_symbol == "IBM", "IBM", CompanyName),
    CompanyName = str_replace(CompanyName, ",", ""),
    CompanyName = str_replace(CompanyName, ".com", ""),
    CompanyName = str_replace(CompanyName, "\\.", ""),
    CompanyName = str_replace(CompanyName, "Corporation", ""),
    CompanyName = str_replace(CompanyName, "Systems", ""),
    CompanyName = str_replace(CompanyName, "Platforms", ""),
    CompanyName = str_trim(CompanyName) 
  )

# Merge data
merged_data <- inner_join(big_tech_stock_prices, big_tech_companies, by = "stock_symbol")

# Group data by year and company and calculate cumulative sum of ClosingPrice
grouped_data <- merged_data |>
  group_by(year = year(date), CompanyName) |>
  summarize(ClosingPrice = mean(close)) |>
  group_by(year) |>
  mutate(CumulativeClosingPrice = cumsum(ClosingPrice)) |>
  mutate(Rank = rank(CumulativeClosingPrice)) |>
  mutate(RoundedCumulativeClosingPrice = round(CumulativeClosingPrice, 0)) |>
  ungroup()

# Order the companies based on cumulative ClosingPrice within each year
grouped_data <- grouped_data |>
  arrange(desc(CumulativeClosingPrice)) |>
  mutate(CompanyName = factor(CompanyName, levels = unique(CompanyName)))

bar_color <- c("#A2AAAD", "#FF0000", "#FF9900", "#1798c1", "#00BCEB", "#34A853", "#0530AD", 
         "#0068B5", "#0668E1", "#F14F21", "#E50914", "#76B900", "#C74634", "#E31937")

# Plot
# Plot
animated_plot <- ggplot(grouped_data) +
  geom_col(aes(x = CumulativeClosingPrice,
               y = fct_reorder(CompanyName, CumulativeClosingPrice),
               fill = CompanyName),
           width = 0.9) +
  geom_text(aes(x = RoundedCumulativeClosingPrice, y = CompanyName, label = RoundedCumulativeClosingPrice ),
            hjust = -0.02, vjust = 0.5) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 10),
        axis.ticks.y = element_blank(),
        plot.margin = unit(c(1, 1, 3, 1), 'lines'),
        legend.position = "none",
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.x = element_line( size=.01, color="grey" )) +
  labs(
    x = "Cumulative Closing Price",
    y = NULL
  ) +
  scale_x_continuous(breaks = seq(0, 4000,by = 500)) +
  scale_x_continuous(limits = c(0, 4000)) +
  ggtitle('Yearwise Closing Price of Big Tech Companies: {closest_state}') +
  scale_fill_manual(values = bar_color) +
  transition_states(year,
                    transition_length = 1,
                    state_length = 10)

# View the animated plot
animated_plot

```


### Discussion

\<\<\< Team-2 to write \>\>

## References

\<\<\< Most Important ; Update as we go \>\>

-   https://stackoverflow.com/questions/10576095/formatting-dates-with-scale-x-date-in-ggplot2
-   https://viz-ggplot2.rsquaredacademy.com/ggplot2-text-annotations
-   
